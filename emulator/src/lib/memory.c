#include "../include/memory.h"
#include <commons/collections/list.h>

t_list *stack;

log_t memory_logger = {.file = "log.log",
                    .process = "MEMORY",
                    .level = LOG_LEVEL_DEBUG,
                    .is_active_console = 1};

u8 ram[4096] = {
    0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
    0x20, 0x60, 0x20, 0x20, 0x70, // 1
    0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
    0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
    0x90, 0x90, 0xF0, 0x10, 0x10, // 4
    0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
    0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
    0xF0, 0x10, 0x20, 0x40, 0x40, // 7
    0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
    0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
    0xF0, 0x90, 0xF0, 0x90, 0x90, // A
    0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
    0xF0, 0x80, 0x80, 0x80, 0xF0, // C
    0xE0, 0x90, 0x90, 0x90, 0xE0, // D
    0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
    0xF0, 0x80, 0xF0, 0x80, 0x80  // F
};

void ram_write(const u8 *stream, u8 offset) { ram[offset] = *stream; }
u8 *ram_read(u8 offset) { return &ram[offset]; }

void stack_push(u16 bytes) {
  u16 *entry = safe_malloc(NULL, sizeof(u16));
  *entry = bytes;
  list_add_in_index(stack, list_size(stack) - 1, entry);
}

u16 stack_pop() {
  u16 *bytes = list_get(stack, list_size(stack) - 1);
  u16 ret = *bytes;
  free(bytes);
  return ret;
}

void memory_init() { stack = list_create(); }
void memory_free() { list_destroy(stack); }
